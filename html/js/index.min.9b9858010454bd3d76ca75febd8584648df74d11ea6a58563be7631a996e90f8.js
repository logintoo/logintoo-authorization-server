(()=>{"use strict";var f="/auth",u="/otp",t=!1;$(function(){M.AutoInit();let e=h(),a=p(e);$("#card").children("div").hide(),a?($("#email-btn").off("click").click(e,o),$("#email").off("keypress keyup change blur").on("keypress keyup change blur",e,c),$("#login-form").show()):$("#error-bad-parameters").show(),$("#card").fadeIn(400),M.updateTextFields(),$("#email").focus()});function h(){let e=new URLSearchParams(window.location.search),a={client_id:e.get("client_id"),code_challenge:e.get("code_challenge"),code_challenge_method:e.get("code_challenge_method"),redirect_uri:e.get("redirect_uri"),response_type:e.get("response_type"),state:e.get("state")};return e.get("language")&&(a.language=e.get("language")),e.get("locale")&&(a.locale=e.get("locale")),a}function p(e){return e.client_id==null||(e.code_challenge==null||(e.code_challenge_method!="S256"||(e.redirect_uri==null||e.response_type!="code")))?!1:!(e.state==null)}function c(e){switch(e.type){case"blur":$(this).val().trim()==""&&($(this).removeClass("invalid"),$(this).removeClass("valid"));break;case"change":$(this).removeClass("invalid"),$(this).removeClass("valid");break;case"keypress":e.keyCode===13&&(t=!0);break;case"keyup":t&&e.keyCode===13?($(this).blur(),t=!1,$(this).attr("id")=="email"&&o(e),$(this).attr("id")=="access-code"&&r(e)):($(this).removeClass("invalid"),$(this).removeClass("valid"));break}}function m(){let e=/^[0-9]{4,8}$/,a=$(this).val().trim();if(a==""){$(this).removeClass("invalid"),$(this).removeClass("valid");return}e.test(a)?($(this).removeClass("invalid"),$(this).addClass("valid")):($(this).removeClass("valid"),$(this).addClass("invalid"))}async function o(e){if($('#email:not([class="invalid"]').hasClass("valid")){let a=$("#email").val().trim();$("#email").val("").val(a).prop("disabled",!0),$("#email-btn").addClass("disabled"),$("#card-preloader").show();try{e.data.email=a;let s=await d("POST",apiURL+f,e.data);if(s.ok){let i={client_id:e.data.client_id,code_challenge:e.data.code_challenge,email:a};$("#code-btn").off("click").click(i,r),$("#access-code").off("keypress keyup change").on("keypress keyup change",i,c),$("#access-code").off("blur").on("blur",m),$("#login-form").hide(),$("#enter-code").fadeIn(400),$("#access-code").focus(),$("#card-preloader").fadeOut(400)}else n(s)}catch(s){l("Could not submit the email address",6e4)}}else $("#email").addClass("invalid").focus()}async function r(e){if($('#access-code:not([class="invalid"]').hasClass("valid")){let a=$("#access-code").val().trim();$("#access-code").val("").val(a).prop("disabled",!0),$("#code-btn").addClass("disabled"),$("#card-preloader").show();try{e.data.otp=a;let s=await d("POST",apiURL+u,e.data);s.ok&&s.redirected?window.location.assign(s.url):n(s)}catch(s){l("Could not submit the access code",6e4)}}else $("#access-code").addClass("invalid").focus()}function d(e,a,s){if(!window.fetch){l(new Error("Bad browser"));return}let i={method:e,headers:{"Content-Type":"application/json"}};return e!="GET"&&e!="HEAD"&&s&&(i.body=JSON.stringify(s)),fetch(a,i)}function n(e){console.error("API Failed:",e);let a="";switch(e.status){case 400:a="Error: Invalid Request";break;case 401:a="The access code is incorrect. Try again.",$("#access-code").prop("disabled",!1).focus(),$("#access-code").removeClass("invalid"),$("#access-code").removeClass("valid"),$("#code-btn").removeClass("disabled"),$("#card-preloader").hide();break;case 403:$("#card").children("div").hide(),$("#error-access-denied").show(),console.log("Access denied");return;case 500:case 503:a="Service is temporarily unavailable. Try again later.",$("#access-code").prop("disabled",!1).focus(),$("#access-code").removeClass("invalid"),$("#access-code").removeClass("valid"),$("#code-btn").removeClass("disabled"),$("#card-preloader").hide();break;default:a="Something went wrong. Try again."}l(a,6e4)}function l(e,a){console.error(e);let s;typeof e=="object"&&(s=e.message),typeof e=="string"&&(s=e),s||(s="Something went wrong"),M.toast({html:s,displayLength:a})}})();
/*!
* Logintoo Sample App (https://sample.logintoo.com)
* Copyright (c) 2020, Eduard Moskvin
* BSD 3-Clause License (https://raw.githubusercontent.com/logintoo/logintoo-sample-app/main/LICENSE)
*/
